name: Sundial Demo Apps
on:
  push:
    branches-ignore:
      - '*WIP'
    paths:
      - 'Examples/Sundial/**'
      - '.github/workflows/sundial-demo.yml'
  workflow_dispatch:
    inputs:
      deploy_testflight:
        description: 'Deploy to TestFlight'
        required: false
        type: boolean
        default: false
  # Uncomment to enable automatic TestFlight deployment on version tags
  # push:
  #   tags:
  #     - 'demo-v*'

env:
  DEMO_PATH: Examples/Sundial

jobs:
  # Build and test demo apps across Xcode versions
  build-demo:
    name: Build Sundial Demo
    runs-on: ${{ matrix.runs-on }}
    if: ${{ !contains(github.event.head_commit.message, 'ci skip') }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # iOS Builds - Latest Xcode
          - type: ios
            runs-on: macos-15
            xcode: "/Applications/Xcode_16.1.app"
            scheme: "SundialCombine"
            deviceName: "iPhone 16 Pro"
            osVersion: "18.1"

          # iOS Stream variant
          - type: ios
            runs-on: macos-15
            xcode: "/Applications/Xcode_16.1.app"
            scheme: "SundialStream"
            deviceName: "iPhone 16 Pro"
            osVersion: "18.1"

          # watchOS Builds
          - type: watchos
            runs-on: macos-15
            xcode: "/Applications/Xcode_16.1.app"
            scheme: "SundialCombine"
            deviceName: "Apple Watch Series 10 (46mm)"
            osVersion: "11.1"

          - type: watchos
            runs-on: macos-15
            xcode: "/Applications/Xcode_16.1.app"
            scheme: "SundialStream"
            deviceName: "Apple Watch Series 10 (46mm)"
            osVersion: "11.1"

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s "${{ matrix.xcode }}"

      - name: Generate Xcode Project
        run: |
          cd ${{ env.DEMO_PATH }}
          xcodegen generate

      - name: Build for ${{ matrix.type }}
        run: |
          cd ${{ env.DEMO_PATH }}
          if [ "${{ matrix.type }}" = "ios" ]; then
            xcodebuild -scheme "${{ matrix.scheme }}" \
              -destination "platform=iOS Simulator,name=${{ matrix.deviceName }},OS=${{ matrix.osVersion }}" \
              clean build
          else
            xcodebuild -scheme "${{ matrix.scheme }}" \
              -destination "platform=watchOS Simulator,name=${{ matrix.deviceName }},OS=${{ matrix.osVersion }}" \
              clean build
          fi

  # Lint demo app code
  lint-demo:
    name: Lint Sundial Demo
    runs-on: ubuntu-latest
    needs: [build-demo]
    if: ${{ !contains(github.event.head_commit.message, 'ci skip') }}
    env:
      LINT_MODE: STRICT
    steps:
      - uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v2
        with:
          version: 2024.11.0
          install: true
          cache: true

      - name: Verify mise tools
        run: mise list

      - name: Lint Demo Apps
        run: |
          cd ${{ env.DEMO_PATH }}
          if [ -f "../../Scripts/lint.sh" ]; then
            ../../Scripts/lint.sh
          else
            echo "Lint script not found - skipping"
          fi

  # Test code signing and archiving (no upload)
  archive-demo:
    name: Test Archive & Code Signing
    runs-on: macos-latest
    needs: [build-demo]
    if: ${{ !contains(github.event.head_commit.message, 'ci skip') }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: ${{ env.DEMO_PATH }}

      - name: Select Xcode
        run: sudo xcode-select -s "/Applications/Xcode_16.1.app"

      - name: Generate keychain password
        id: keychain
        run: echo "password=$(openssl rand -base64 32)" >> $GITHUB_OUTPUT

      - name: Archive Pulse (test code signing)
        run: |
          cd ${{ env.DEMO_PATH }}
          bundle exec fastlane build_only_pulse
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_KEYCHAIN_PASSWORD: ${{ steps.keychain.outputs.password }}
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
          DEVELOPMENT_TEAM: MLT7M394S7

      - name: Archive Flow (test code signing)
        run: |
          cd ${{ env.DEMO_PATH }}
          bundle exec fastlane build_only_flow
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_KEYCHAIN_PASSWORD: ${{ steps.keychain.outputs.password }}
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
          DEVELOPMENT_TEAM: MLT7M394S7

  # TestFlight deployment (manual trigger only)
  deploy-testflight:
    name: Deploy to TestFlight
    runs-on: macos-latest
    needs: [build-demo, lint-demo, archive-demo]
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.deploy_testflight == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: ${{ env.DEMO_PATH }}

      - name: Select Xcode
        run: sudo xcode-select -s "/Applications/Xcode_16.1.app"

      - name: Generate Xcode Project
        run: |
          cd ${{ env.DEMO_PATH }}
          xcodegen generate

      - name: Generate keychain password
        id: keychain
        run: echo "password=$(openssl rand -base64 32)" >> $GITHUB_OUTPUT

      - name: Deploy Pulse to TestFlight
        run: |
          cd ${{ env.DEMO_PATH }}
          bundle exec fastlane beta_pulse
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_KEYCHAIN_PASSWORD: ${{ steps.keychain.outputs.password }}
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
          DEVELOPMENT_TEAM: MLT7M394S7

      - name: Deploy Flow to TestFlight
        run: |
          cd ${{ env.DEMO_PATH }}
          bundle exec fastlane beta_flow
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_KEYCHAIN_PASSWORD: ${{ steps.keychain.outputs.password }}
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
          DEVELOPMENT_TEAM: MLT7M394S7
