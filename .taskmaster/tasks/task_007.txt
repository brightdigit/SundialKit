# Task ID: 7
# Title: Implement SundialKitStream modern async plugin
# Status: pending
# Dependencies: 2, 3
# Priority: medium
# Description: Create actor-based AsyncStream plugin with NetworkStream and ConnectivityStream using Swift 6.1 strict concurrency
# Details:
Create modern SundialKitStream plugin with Swift 6.1:
1. actor NetworkStream implementation:
   - Wrap NetworkMonitor with actor isolation
   - pathStatusStream: AsyncStream<PathStatus>
   - isExpensiveStream: AsyncStream<Bool>
   - isConstrainedStream: AsyncStream<Bool>
   - async func currentStatus() -> PathStatus
   - Implement NetworkStateObserver, bridge to AsyncStream
2. actor ConnectivityStream implementation:
   - Wrap ConnectivityManager with actor isolation
   - activationStateStream: AsyncStream<ActivationState>
   - isReachableStream: AsyncStream<Bool>
   - messageStream: AsyncStream<ReceivedMessage>
   - async func send<M>(_ message: M) throws
   - async func activate() throws(ConnectivityError)
3. Full Swift 6.1 strict concurrency enabled
4. No @available guards - declare platforms in Package.swift
5. Thread-safe by default via actor isolation
6. No swift-async-algorithms dependency

Platform: iOS 13+, macOS 10.15+, watchOS 6+, tvOS 13+

# Test Strategy:
Swift Testing required. Test actor isolation, AsyncStream delivery, concurrent access safety, proper cleanup on stream termination, typed throws behavior.

# Subtasks:
## 1. Create NetworkStream actor with isolation boundaries [pending]
### Dependencies: None
### Description: Implement the core NetworkStream actor that wraps NetworkMonitor with proper actor isolation, ensuring thread-safe access to all network state
### Details:
Create NetworkStream actor in SundialKitStream target. Define actor NetworkStream with private let networkMonitor: NetworkMonitor. Implement actor isolation boundaries for all state access. Add private continuation storage for AsyncStream management. Implement proper initialization with NetworkMonitor dependency injection. Ensure all public APIs are properly isolated to the actor context.

## 2. Implement AsyncStream bridges for network properties [pending]
### Dependencies: 7.1
### Description: Create AsyncStream publishers for pathStatus, isExpensive, and isConstrained properties with proper continuation lifecycle management
### Details:
Implement pathStatusStream: AsyncStream<PathStatus> using AsyncStream.makeStream(). Create isExpensiveStream and isConstrainedStream similarly. Implement NetworkStateObserver conformance to receive updates from NetworkMonitor. Bridge observer callbacks to AsyncStream continuations. Handle continuation lifecycle with proper cleanup on stream termination. Implement async func currentStatus() -> PathStatus for synchronous state access.

## 3. Create ConnectivityStream actor with message handling [pending]
### Dependencies: None
### Description: Implement the core ConnectivityStream actor that wraps ConnectivityManager with actor isolation for thread-safe WatchConnectivity operations
### Details:
Create ConnectivityStream actor in SundialKitStream target. Define actor ConnectivityStream with private let connectivityManager: ConnectivityManager. Implement actor isolation for all connectivity state and message handling. Add private continuation storage for multiple AsyncStream instances. Handle message queue buffering for async delivery. Ensure proper actor context isolation for all public methods.

## 4. Implement AsyncStream for connectivity state and messages [pending]
### Dependencies: 7.3
### Description: Create AsyncStream publishers for connectivity state properties and incoming messages with proper continuation management
### Details:
Implement activationStateStream: AsyncStream<ActivationState> using AsyncStream.makeStream(). Create isReachableStream: AsyncStream<Bool> for reachability state. Implement messageStream: AsyncStream<ReceivedMessage> for incoming messages. Create ConnectivityStateObserver conformance to receive updates. Bridge observer callbacks to appropriate stream continuations. Handle multiple consumers and continuation lifecycle properly.

## 5. Add async send and activate methods with typed throws [pending]
### Dependencies: 7.3, 7.4
### Description: Implement async methods for sending messages and activating connectivity with Swift 6.1 typed throws for specific error handling
### Details:
Implement async func send<M>(_ message: M) throws(ConnectivityError) where M: Sendable. Convert synchronous ConnectivityManager.send to async with proper error propagation. Implement async func activate() throws(ConnectivityError) for session activation. Use Swift 6.1 typed throws syntax for ConnectivityError. Handle timeout scenarios with withTaskCancellationHandler. Ensure proper actor isolation for all async operations.

## 6. Ensure Swift 6.1 strict concurrency compliance [pending]
### Dependencies: 7.1, 7.2, 7.3, 7.4, 7.5
### Description: Verify and enforce full Swift 6.1 strict concurrency mode compliance throughout the plugin with proper Sendable conformance
### Details:
Enable strict concurrency checking in Package.swift with swiftLanguageVersions: [.v6_1]. Ensure all types conform to Sendable where appropriate. Fix any concurrency warnings or errors. Verify actor isolation boundaries are properly maintained. Check that all closures and continuations are properly isolated. Remove any @unchecked Sendable usage. Validate no data races are possible.

## 7. Write comprehensive actor isolation and stream tests [pending]
### Dependencies: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6
### Description: Create thorough test suite using Swift Testing to verify actor isolation, stream behavior, and concurrent operation safety
### Details:
Write NetworkStreamTests using Swift Testing framework. Test actor isolation with concurrent access patterns. Verify AsyncStream delivery and cleanup behavior. Write ConnectivityStreamTests for message handling and state streams. Test error propagation with typed throws. Verify proper cleanup and resource management. Test stream cancellation and continuation lifecycle. Add performance tests for concurrent operations.

