# Task ID: 2
# Title: Extract NetworkMonitor from NetworkObserver
# Status: done
# Dependencies: 1
# Priority: high
# Description: Create non-reactive NetworkMonitor class in SundialKitNetwork target by extracting core logic from v1.0.0 NetworkObserver in Sources/SundialKit/Network/NetworkObserver.swift
# Details:
Extract and refactor NetworkMonitor from Sources/SundialKit/Network/NetworkObserver.swift:
1. Move core network monitoring logic from NetworkObserver to new NetworkMonitor class in SundialKitNetwork target
2. Remove all Combine dependencies (Published, PassthroughSubject, AnyCancellable from lines 71-79)
3. Implement NetworkMonitoring protocol from SundialKitCore
4. Maintain PathMonitor protocol abstraction from Sources/SundialKit/Network/PathMonitor.swift
5. Support optional NetworkPing integration from Sources/SundialKit/Network/NetworkPing.swift
6. Replace pathStatusSubject, isExpensiveSubject, isConstrainedSubject with observer pattern using NetworkStateObserver protocol
7. Use weak references array for observers to prevent retain cycles
8. Extract DefaultPathMonitor from Sources/SundialKit/Network/Extensions/NWPathMonitor.swift implementation
9. Replace Timer.publish and Combine operators with direct Timer/DispatchQueue scheduling for NetworkPing
10. Thread-safe state management with NSLock for observer array
11. Platform-specific NWPathMonitor implementation with proper queue handling

Key refactoring from existing NetworkObserver.swift:
- Replace lines 71-79 PassthroughSubjects with stored properties and observer callbacks
- Extract onUpdate(path:) method (line 140-142) to work without pathSubject
- Adapt start/cancel methods (lines 122-138) removing Combine publishers
- Maintain existing PathMonitor and NetworkPing abstractions
- Swift 5.9+ compatibility maintaining existing platform support

# Test Strategy:
Swift Testing required. Port existing test patterns from Tests/SundialKitTests/Network/NetworkObserverTests.swift. Test state changes, observer notifications, PathMonitor mock implementations (MockPathMonitor), NetworkPing integration (MockNetworkPing), thread safety with concurrent observers, platform-specific behavior, and lifecycle management.

# Subtasks:
## 1. Create NetworkMonitor class structure implementing NetworkMonitoring protocol [done]
### Dependencies: None
### Description: Create the foundational NetworkMonitor class in SundialKitNetwork target with proper imports, class declaration, and NetworkMonitoring protocol conformance
### Details:
Create Sources/SundialKitNetwork/NetworkMonitor.swift file. Import Foundation and Network frameworks. Declare public class NetworkMonitor implementing NetworkMonitoring protocol from SundialKitCore. Add private properties for pathMonitor (PathMonitor protocol), networkPing (optional NetworkPing), observerQueue (DispatchQueue), and state storage properties (currentPathStatus, currentIsExpensive, currentIsConstrained). Include thread-safe observer array property using NSLock for synchronization. Add initializer accepting optional PathMonitor and NetworkPing instances similar to NetworkObserver init(monitor:pingOrNil:) from line 109-118.

## 2. Extract PathMonitor abstraction and NWPathMonitor implementation from existing code [done]
### Dependencies: 2.1
### Description: Move PathMonitor protocol and DefaultPathMonitor implementation from NetworkObserver to separate files in SundialKitNetwork
### Details:
Extract PathMonitor protocol from Sources/SundialKit/Network/PathMonitor.swift into Sources/SundialKitNetwork/PathMonitor.swift. Create DefaultPathMonitor class wrapping NWPathMonitor based on the extension in Sources/SundialKit/Network/Extensions/NWPathMonitor.swift (lines 34-38). Replace onPathUpdate handler closure approach with direct callback pattern instead of pathUpdateHandler property. Adapt existing NWPathMonitor wrapper removing any Combine-specific logic. Maintain platform availability checks @available(macOS 10.15, iOS 13, watchOS 6, tvOS 13, *) and proper queue handling. Update NetworkMonitor to use extracted PathMonitor abstraction.

## 3. Implement observer pattern with weak references and thread-safe state management [done]
### Dependencies: 2.1, 2.2
### Description: Implement NetworkStateObserver protocol and weak reference array for managing multiple observers with thread safety
### Details:
Define NetworkStateObserver protocol in SundialKitCore with methods: networkStateDidChange(pathStatus:isExpensive:isConstrained:). Create WeakObserver wrapper class to hold weak references preventing retain cycles. Implement thread-safe observer management using NSLock: addObserver(), removeObserver(), and private notifyObservers() methods. Ensure all state updates acquire lock before modification. Implement cleanup mechanism to remove deallocated observers. Add observer notification logic to PathMonitor update handler ensuring observers are called on main queue or specified queue. This replaces the pathSubject.map().subscribe() pattern from NetworkObserver lines 113-115.

## 4. Extract and adapt NetworkPing integration logic [done]
### Dependencies: 2.1, 2.2, 2.3
### Description: Move NetworkPing functionality from NetworkObserver to NetworkMonitor, removing Combine dependencies
### Details:
Extract NetworkPing protocol from Sources/SundialKit/Network/NetworkPing.swift and remove Combine extensions (lines 93-124). Remove PassthroughSubject pingStatusSubject and replace with direct callback pattern or observer notification. Replace Timer.publish().autoconnect().prepend() pattern (lines 104-112) with Timer.scheduledTimer or DispatchSourceTimer. Remove Publishers.CombineLatest and flatMap operators (lines 114-121) with direct scheduling logic. Add pingStatus property to NetworkMonitor state. Integrate ping results into observer notifications. Handle ping failures and timeout scenarios. Ensure optional ping support - NetworkMonitor should function without NetworkPing instance. Maintain existing ping interval and timeout configurations from timeInterval property.

## 5. Remove Combine dependencies and replace with stored properties [done]
### Dependencies: 2.1, 2.2, 2.3, 2.4
### Description: Refactor all Combine-specific code replacing @Published properties and PassthroughSubjects with regular stored properties
### Details:
Remove all Combine imports from NetworkMonitor. Replace NetworkObserver's PassthroughSubjects (lines 71, 76-79): pathStatusSubject, isExpensiveSubject, isConstrainedSubject, pingStatusSubject with private(set) stored properties: currentPathStatus: PathStatus, currentIsExpensive: Bool, currentIsConstrained: Bool, currentPingStatus. Remove AnyCancellable arrays (lines 72, 74) and cancellable management. Remove pathSubject.map().subscribe() chains (lines 113-115) and replace with direct property assignment in path update handler. Ensure state updates trigger observer notifications instead of publisher events. Update all internal state management to use direct property assignment with proper thread synchronization. Maintain state consistency during updates.

## 6. Implement state query methods and lifecycle management [done]
### Dependencies: 2.1, 2.2, 2.3, 2.4, 2.5
### Description: Implement NetworkMonitoring protocol methods for state queries and complete lifecycle management including start/stop functionality
### Details:
Implement pathStatus() -> PathStatus method returning current path status. Implement isExpensive() -> Bool and isConstrained() -> Bool query methods. Adapt start(queue: DispatchQueue) method from NetworkObserver (lines 122-128) removing timerCancellable and ping.publish() calls, replacing with direct Timer scheduling. Implement stop() method based on cancel() (lines 131-138) for cancelling PathMonitor, stopping NetworkPing timers, and clearing observers. Add isMonitoring property tracking active state. Ensure proper cleanup in deinit clearing all timers and observers. Handle edge cases like multiple start/stop calls. Implement any additional NetworkMonitoring protocol requirements from SundialKitCore. Maintain onUpdate(path:) functionality (lines 140-142) adapted for observer pattern.

## 7. Create comprehensive unit tests with mocks [done]
### Dependencies: 2.6
### Description: Develop complete test suite using Swift Testing framework with mock implementations for all dependencies
### Details:
Create Tests/SundialKitNetworkTests/NetworkMonitorTests.swift using Swift Testing framework. Port test patterns from Tests/SundialKitTests/Network/NetworkObserverTests.swift adapting for observer pattern. Implement MockPathMonitor conforming to PathMonitor protocol with controllable behavior (based on existing MockPathMonitor). Create MockNetworkPing for testing ping integration (based on existing MockNetworkPing). Write tests for: initialization with various configurations, observer registration and notification, state transitions and updates, thread safety with concurrent operations, PathMonitor integration, NetworkPing optional behavior, lifecycle management (start/stop/deinit), error handling and edge cases. Adapt existing test methods like testStart(), testCancel(), testPathStatusPublisher() for observer pattern instead of publishers. Ensure minimum 80% code coverage. Test platform-specific behavior where applicable.

## 8. Update Package.swift to define SundialKitNetwork target [done]
### Dependencies: 2.7
### Description: Add SundialKitNetwork target to Package.swift with proper dependencies and platform support
### Details:
Update Package.swift to add SundialKitNetwork target definition. Add dependencies on SundialKitCore for protocols. Configure platform restrictions matching current SundialKit (.iOS(.v13), .watchOS(.v6), .tvOS(.v13), .macOS(.v10_13)). Add SundialKitNetwork to library products. Create corresponding test target SundialKitNetworkTests with dependency on SundialKitNetwork. Ensure Network framework is properly linked for NWPathMonitor usage. Remove Network components from main SundialKit target preparation for separation.

